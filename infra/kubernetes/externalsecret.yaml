# External Secrets Operator (ESO) — ExternalSecret resources
# Pulls secrets from HashiCorp Vault and syncs them into native K8s Secrets.
# Install ESO first: helm install external-secrets external-secrets/external-secrets -n external-secrets-operator --create-namespace

---
# SecretStore — points ESO at your Vault instance
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: ventro-vault-store
  namespace: ventro
spec:
  provider:
    vault:
      server: "https://vault.example.com:8200"   # Change to your Vault address
      path: "secret"
      version: "v2"
      auth:
        tokenSecretRef:
          name: vault-token
          key: token

---
# The native Secret that ESO populates with token for Vault auth
# kubectl create secret generic vault-token --from-literal=token=<VAULT_TOKEN> -n ventro
apiVersion: v1
kind: Secret
metadata:
  name: vault-token
  namespace: ventro
type: Opaque
data: {}   # Populated by Cluster bootstrapper / CI

---
# ExternalSecret → syncs Vault secrets into ventro-app-secrets K8s Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ventro-app-secrets
  namespace: ventro
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: ventro-vault-store
    kind: SecretStore
  target:
    name: ventro-app-secrets
    creationPolicy: Owner
  data:
    - secretKey: SECRET_KEY
      remoteRef: { key: ventro/production, property: secret_key }
    - secretKey: DATABASE_URL
      remoteRef: { key: ventro/production, property: database_url }
    - secretKey: MONGO_URL
      remoteRef: { key: ventro/production, property: mongo_url }
    - secretKey: GROQ_API_KEY
      remoteRef: { key: ventro/production, property: groq_api_key }
    - secretKey: FILE_ENCRYPTION_KEY
      remoteRef: { key: ventro/production, property: file_encryption_key }
    - secretKey: VAULT_ADDR
      remoteRef: { key: ventro/production, property: vault_addr }
    - secretKey: VAULT_TOKEN
      remoteRef: { key: ventro/production, property: vault_token }
    - secretKey: WEBHOOK_SIGNING_KEY
      remoteRef: { key: ventro/production, property: webhook_signing_key }
    - secretKey: LANGFUSE_PUBLIC_KEY
      remoteRef: { key: ventro/production, property: langfuse_public_key }
    - secretKey: LANGFUSE_SECRET_KEY
      remoteRef: { key: ventro/production, property: langfuse_secret_key }
